# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Run

```bash
# Build the API
go build -o bin/main ./cmd/api

# Run the server (requires PostgreSQL)
DATABASE_URL="postgres://postgres:postgres@localhost:5432/fswithgo?sslmode=disable" ./bin/main

# Live reload during development (uses .air.toml config)
air

# Run migrations (note: uses pgx5:// scheme, not postgres://)
DATABASE_URL="pgx5://postgres:postgres@localhost:5432/fswithgo?sslmode=disable" go run ./cmd/migrate -direction up
DATABASE_URL="pgx5://postgres:postgres@localhost:5432/fswithgo?sslmode=disable" go run ./cmd/migrate -direction down

# Regenerate sqlc code after changing .sql files
sqlc generate

# Tidy dependencies
go mod tidy
```

### Frontend (web/)

```bash
cd web
pnpm dev       # Vite dev server
pnpm build     # tsc -b && vite build
pnpm lint      # eslint
```

The frontend reads `VITE_API_URL` (defaults to `http://localhost:8080`).

### Docker

```bash
docker compose up        # Postgres on :5433, API on :8080
docker compose up db     # Postgres only (host port 5433 → container 5432)
```

Note: Docker Compose maps Postgres to **port 5433** on the host (not 5432). When running the API locally against the Docker DB, use port 5433 in `DATABASE_URL`. The `scripts/entrypoint.sh` script auto-converts `postgres://` to `pgx5://` and runs migrations before starting the API.

No tests yet. Default server port is `:3000` (override with `ADDR` env var). CORS origin defaults to `http://localhost:3000` (override with `CORS_ORIGIN` env var).

## Architecture

Full-stack app: Go REST API backend + React/TypeScript/Vite frontend (`web/`).

### Backend (Go)

Go REST API using only `net/http` (no third-party router), pgx/v5 native mode, sqlc for query generation, golang-migrate for schema migrations.

**Key Layers:**

- **`cmd/api/`** — Entrypoint and HTTP layer. `main.go` creates pgxpool, wires Storage. `api.go` defines `application` struct, routes (`mount()`), server (`run()`). Handlers are methods on `application`.
- **`cmd/api/helpers/`** — JSON request/response utilities (`ReadJson`, `WriteJson`, `ErrorJson`, `ValidationErrorJson`). All JSON responses use the `Envelope` wrapper type (`map[string]interface{}`). `ReadJson` enforces a 1 MB body limit and disallows unknown fields.
- **`cmd/api/middleware/`** — Middleware stack via `CreateStack()`. Order: CORS → Recoverer → RequestID → RealIP → Logging → Timeout(25s).
- **`cmd/migrate/`** — Migration runner using golang-migrate. Migrations live in `cmd/migrate/migrations/` as numbered up/down `.sql` pairs.
- **`internal/db/`** — pgxpool connection helper (`db.New()` returns `*pgxpool.Pool`).
- **`internal/store/`** — Domain types and repository layer. `Storage` struct has interface fields (`Issues`, `Authors`) for DI/mocking. `IssueStore` and `AuthorStore` wrap sqlc-generated `Queries` and translate between domain types and generated types. Uses `store.ErrNotFound` sentinel error.
- **`internal/store/queries/`** — sqlc-annotated `.sql` query files. Edit these, then run `sqlc generate`.
- **`internal/store/dbsqlc/`** — **Generated by sqlc, never edit.** Contains `Queries` struct, `DBTX` interface, and generated models.
- **`internal/env/`** — Environment variable helpers (`GetString`, `GetInt`) with fallback defaults.

**Patterns:**

- **Repository pattern**: `Storage` fields are interfaces, not concrete types. Concrete implementations wrap `*dbsqlc.Queries`.
- **Anti-corruption layer**: Domain structs (`store.Issue`) are separate from generated structs (`dbsqlc.Issue`). Store methods translate between them (e.g., `pgtype.Timestamptz` → `time.Time`).
- **Routing**: Go 1.22+ method-pattern syntax (e.g., `"GET /v1/health"`). All routes defined in `api.go:mount()`.
- **Handler validation**: Handlers define inline input structs, parse JSON with `helpers.ReadJson`, validate fields manually into an `errs` map, then call `helpers.ValidationErrorJson` on failure.
- **Config**: Environment variables via `internal/env` with defaults. DB config: `DATABASE_URL`, `DB_MAX_CONNS`, `DB_MAX_IDLE_MINS`.
- **sqlc overrides** (in `sqlc.yaml`): PostgreSQL `uuid` maps to `google/uuid.UUID`, `status_type` enum maps to Go `string`.

### Frontend (web/)

React 19 + TypeScript + Vite 7 SPA. Uses TanStack Query v5 for server state, Zod v4 for validation, shadcn/ui (New York style) with Radix UI primitives and Tailwind CSS v4.

**Key directories under `web/src/`:**

- **`api/`** — `apiFetch<T>()` wrapper around fetch; entity-specific API modules (e.g., `issues.ts`).
- **`hooks/`** — TanStack Query hooks wrapping API calls (e.g., `useIssues`, `useCreateIssues`).
- **`schemas/`** — Zod schemas defining API types and validation (e.g., `StatusType`, `IssueSchema`).
- **`components/ui/`** — Installed shadcn/ui primitives. Path alias `@/` maps to `src/`.

### Adding a New Entity

1. Create migration: `cmd/migrate/migrations/000003_create_<name>.up.sql` / `.down.sql`
2. Write queries: `internal/store/queries/<name>.sql` with sqlc annotations
3. Run `sqlc generate`
4. Add domain struct + store wrapper in `internal/store/<name>.go`
5. Add interface field to `Storage`, wire in `NewStorage()`
6. Add handler methods on `application` in `cmd/api/<name>.go`
7. Register routes in `api.go:mount()`
